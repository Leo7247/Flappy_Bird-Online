<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird - 聲控版 (micro:bit) + 虛擬美元 & 樣式商店</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 70%, #F0F8FF 100%); overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; cursor: pointer; }

        /* Top bar - very compact */
        #topBar {
            position: absolute; top: 8px; left: 8px; z-index: 30; display: flex; gap: 6px;
        }
        .topBtn {
            padding: 6px 10px; font-size: 15px; background: #0066cc; color: white;
            border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #connectBluetooth { font-size: 15px; }
        #toggleSettings { font-size: 18px; padding: 6px 9px; }
        #menuBtn { font-size: 20px; padding: 4px 10px; }

        #volumeBar { position: absolute; top: 10px; right: 280px; width: 26px; height: 190px; background: #ddd; border: 3px solid #555; border-radius: 8px; overflow: hidden; z-index: 20; }
        #volumeFill { width: 100%; height: 0%; background: linear-gradient(to top, #ff4d4d, #ffff66, #66ff66); position: absolute; bottom: 0; transition: height 0.08s linear; }

        /* Settings panel - tiny & clean */
        #controls {
            position: absolute; top: 50px; right: 10px; z-index: 20;
            background: rgba(255,255,255,0.95); padding: 12px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); width: 240px; max-height: 85vh; overflow-y: auto;
            display: none;
        }
        #controls.show { display: block; }
        #controls h3 { text-align: center; margin: 8px 0 12px; color: #0066cc; font-size: 18px; }
        .control-item { margin: 12px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input[type="range"], select { width: 100%; }
        button { padding: 7px 10px; margin-top: 5px; cursor: pointer; width: 100%; border-radius: 6px; font-size: 14px; }

        /* Game Menu */
        #gameMenu {
            position: absolute; top: 50px; left: 10px; z-index: 50;
            background: white; padding: 12px; border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3); display: none; width: 170px;
        }
        #gameMenu button { margin: 6px 0; width: 100%; padding: 10px; font-size: 15px; }

        /* Paused overlay */
        .paused-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 100px; color: rgba(255,255,255,0.95); text-shadow: 0 0 25px black;
            z-index: 40; pointer-events: none; display: none; font-weight: bold;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="topBar">
    <button id="connectBluetooth" class="topBtn">連線 micro:bit</button>
    <button id="toggleSettings" class="topBtn">⚙️</button>
    <button id="menuBtn" class="topBtn">≡</button>
</div>

<div id="volumeBar"><div id="volumeFill"></div></div>

<!-- Settings Panel -->
<div id="controls">
    <h3>虛擬美元: <span id="dollarsDisplay">0</span> $</h3>
    <h3>最高等級: <span id="highestLevelDisplay">1</span></h3>
    <h3>當前樣式: <span id="currentStyleName">經典橙鳥</span></h3>

    <div class="control-item"><label>音效</label><input type="checkbox" id="soundToggle" checked></div>
    <div class="control-item"><label>動畫效果</label><input type="checkbox" id="animationsToggle" checked></div>

    <h3>鳥兒樣式商店</h3>
    <div id="shopList"></div>

    <div class="control-item">
        <label>跳躍聲量閾值: <span id="jumpThresholdValue">140</span></label>
        <input type="range" id="jumpThreshold" min="60" max="220" value="140" step="5">
    </div>
    <div class="control-item">
        <label>難度模式: <span id="difficultyMode">Normal</span> (間隙: <span id="pipeGapValue">220</span>)</label>
        <select id="difficultySelect">
            <option value="140">Super Hard</option>
            <option value="180">Hard</option>
            <option value="220" selected>Normal</option>
            <option value="280">Easy</option>
            <option value="320">Super Easy</option>
        </select>
    </div>
</div>

<!-- Game Menu -->
<div id="gameMenu">
    <button id="pauseMenuBtn">暫停遊戲</button>
    <button id="restartMenuBtn">重新開始</button>
</div>

<div class="paused-text" id="pausedText">PAUSED</div>

<script>
// ==================== 持久化數據 ====================
let data = { dollars: 0, highestLevel: 1, currentStyle: 0, unlockedStyles: [0], animationsOn: true, soundOn: true };

function loadData() { if (localStorage.gameData) data = JSON.parse(localStorage.gameData); }
function saveData() { localStorage.gameData = JSON.stringify(data); }

// ==================== 鳥兒樣式 (新增 3 款) ====================
const birdStyles = [
    { name: "經典橙鳥", body: "#FF9500", wing: "#FF6600", beak: "#FFCC33", cost: 0 },
    { name: "藍傑伊", body: "#4488FF", wing: "#2266CC", beak: "#FFFF66", cost: 80 },
    { name: "紅雀", body: "#FF4444", wing: "#CC0000", beak: "#FFAA00", cost: 160 },
    { name: "金鳳凰", body: "#FFD700", wing: "#FFAA00", beak: "#FFFF00", cost: 400, glow: true },

    // === 新增 3 款皮膚 ===
    { name: "綠鸚鵡", body: "#00CC66", wing: "#009944", beak: "#FFDD44", cost: 250 },
    { name: "紫貓頭鷹", body: "#BB66FF", wing: "#8844CC", beak: "#FFBB22", cost: 350 },
    { name: "霓虹鳥", body: "#FF00FF", wing: "#00FFFF", beak: "#FFFF00", cost: 600, glow: true }
];

// ==================== 音效 ====================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, dur=0.1, type='sine', vol=0.3) {
    if (!data.soundOn) return;
    const osc = audioCtx.createOscillator(); osc.type = type; osc.frequency.value = freq;
    const gain = audioCtx.createGain(); gain.gain.value = vol;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}
function playFlap() { playSound(600, 0.08, 'triangle', 0.2); }
function playScore() { playSound(880, 0.08); playSound(1100, 0.12); }
function playDie() {
    if (!data.soundOn) return;
    const osc = audioCtx.createOscillator(); osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.7);
    const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.7);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.7);
}

// ==================== 遊戲核心 (不變) ====================
// ... (所有遊戲核心、粒子、雲朵、鳥兒繪製、micro:bit 等程式碼保持完全相同) ...

// ==================== 更新介面 (自動支援新皮膚) ====================
function updateDisplays() {
    document.getElementById('dollarsDisplay').textContent = data.dollars;
    document.getElementById('highestLevelDisplay').textContent = data.highestLevel;
    document.getElementById('currentStyleName').textContent = birdStyles[data.currentStyle].name;

    const shopList = document.getElementById('shopList');
    shopList.innerHTML = '';
    for (let i = 0; i < birdStyles.length; i++) {
        const s = birdStyles[i];
        const div = document.createElement('div'); div.className = 'control-item';
        const lab = document.createElement('label'); lab.textContent = `${s.name} (${s.cost} $)`; div.appendChild(lab);
        const btn = document.createElement('button');
        if (data.unlockedStyles.includes(i)) {
            btn.textContent = data.currentStyle === i ? '已裝備' : '裝備';
            btn.disabled = data.currentStyle === i;
            btn.onclick = () => { data.currentStyle = i; updateDisplays(); saveData(); };
        } else {
            if (data.dollars >= s.cost) {
                btn.textContent = '購買並裝備';
                btn.onclick = () => {
                    data.dollars -= s.cost;
                    data.unlockedStyles.push(i);
                    data.currentStyle = i;
                    updateDisplays(); saveData();
                };
            } else {
                btn.textContent = '美元不足';
                btn.disabled = true;
            }
        }
        div.appendChild(btn); shopList.appendChild(div);
    }
}

// ... (其餘 micro:bit、難度模式、設定面板、遊戲選單等程式碼保持不變) ...

// 初始化
loadData();
updateDisplays();

</script>
</body>
</html>
